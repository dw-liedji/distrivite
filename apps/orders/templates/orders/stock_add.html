{% extends "core/quanta.html" %}
{% load crispy_forms_tags %}
{% load partials %}
{% load core %}

{% block title %}
Create stock
{% endblock title %}

{% block quanta_content %}
{% partialdef add inline=True %}
{% include "core/partials/messages.html" %}

<section class="section fade-in">
    <div class="container">
        <div class="columns">
            <div class="column is-half is-offset-one-quarter">
                <div class="box">
                    <h1 class="title is-4 has-text-centered">Create stock</h1>
                    <button id="start-scan">Scan Barcode</button>
                    <div id="barcode-video" width="300" height="200" style="display:none;"></div>
                    <p id="result"></p>
                    <form action="" method="POST" class="mb-4">
                        {% csrf_token %}
                        {{ form|crispy }}
                        {{ form.media }}
                        <div class="columns is-multiline is-mobile">
                            <div class="column is-full-mobile is-flex is-justify-content-center is-align-stocks-center">
                                <button type="button"
                                    hx-get="{% url 'organization_features:orders:stock_list' request.organization.slug %}?{% url_replace %}"
                                    hx-target="#quanta_content" hx-indicator="#custom-htmx-indicator"
                                    hx-swap="innerHTML"
                                    class="button is-light is-rounded is-medium mx-2 has-text-grey-dark dark:has-text-grey-light">
                                    Cancel
                                </button>

                                <button type="submit"
                                    hx-post="{% url 'organization_features:orders:stock_add' request.organization.slug %}?{% url_replace %}"
                                    hx-target="#quanta_content" hx-indicator="#custom-htmx-indicator"
                                    hx-swap="innerHTML" class="button is-primary is-rounded is-medium mx-2">
                                    Save Now
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
<script>
    document.getElementById("start-scan").addEventListener("click", function () {
        const video = document.getElementById("barcode-video");
        video.style.display = "block"; // Show the video

        const quaggaConf = {
            inputStream: {
                target: video,
                type: "LiveStream",
                constraints: {
                    width: {
                        min: 640
                    },
                    height: {
                        min: 480
                    },
                    facingMode: "environment",
                    aspectRatio: {
                        min: 1,
                        max: 2
                    }
                }
            },
            decoder: {
                readers: ['code_128_reader']
            },
        }

        Quagga.init(quaggaConf, function (err) {
            if (!err) {
                Quagga.start();
            }
        });

        Quagga.onDetected(function (data) {
            let barcode = data.codeResult.code;
            document.getElementById("barcode-input").value = barcode; // Auto-fill form input
            document.getElementById("result").textContent = "Scanned: " + barcode;
            Quagga.stop(); // Stop scanning after success
        });
    });
</script>
{% include "core/partials/dal_fix.html" %}
{% endpartialdef  %}
{% endblock quanta_content %}